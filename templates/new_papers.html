{% extends "base.html" %}
{% block content %}
<div class="container mb-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>New Papers</h3>
    <div>
      <a href="{{ url_for('saved_searches') }}" class="btn btn-outline-primary me-2">Saved Searches</a>
      <a href="{{ url_for('index') }}" class="btn btn-primary">New Search</a>
    </div>
  </div>

  <!-- Filter Options -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Filter Options</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('new_papers') }}" class="row g-3">
        <div class="col-md-5">
          <label class="form-label">Saved Search</label>
          <select class="form-select" name="search_id" onchange="this.form.submit()">
            <option value="">All Saved Searches</option>
            {% for search in saved_searches %}
            <option value="{{ search.id }}" {% if selected_search_id and selected_search_id|int == search.id %}selected{% endif %}>
              {{ search.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label">Database</label>
          <select class="form-select" name="database" onchange="this.form.submit()">
            <option value="">All Databases</option>
            <option value="pubmed" {% if selected_database == 'pubmed' %}selected{% endif %}>PubMed</option>
            <option value="arxiv" {% if selected_database == 'arxiv' %}selected{% endif %}>arXiv</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Papers List -->
  {% if papers %}
  <div class="papers-list">
    {% for paper in papers %}
    <div class="card mb-3 paper-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <span class="badge {% if paper.database == 'pubmed' %}bg-info{% elif paper.database == 'arxiv' %}bg-warning{% else %}bg-secondary{% endif %}">
            {{ paper.database|upper }}
          </span>
          <small class="text-muted ms-2">Found: {{ paper.found_date.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
        <form method="POST" action="{{ url_for('mark_as_read', paper_id=paper.id) }}">
          <button type="submit" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-check2"></i> Mark as Read
          </button>
        </form>
      </div>
      <div class="card-body">
        <h5 class="card-title">
          <a href="{{ paper.url }}" target="_blank" class="text-decoration-none">{{ paper.title }}</a>
        </h5>
        <h6 class="card-subtitle mb-2 text-muted">{{ paper.authors }}</h6>
        
        {% if paper.publication_date %}
        <p class="card-text">
          <small class="text-muted">Published: {{ paper.publication_date.strftime('%Y-%m-%d') }}</small>
        </p>
        {% endif %}
        
        {% if paper.abstract %}
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary" type="button" 
                  data-bs-toggle="collapse" data-bs-target="#abstract-{{ paper.id }}" 
                  aria-expanded="false">
            Show Abstract
          </button>
          <div class="collapse mt-2" id="abstract-{{ paper.id }}">
            <div class="card card-body">
              {{ paper.abstract }}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="card-footer text-muted">
        <small>From saved search: <strong>{{ paper.search.name }}</strong></small>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">
    <p>No new papers found matching your criteria.</p>
    <p>Run your saved searches to check for new papers, or create new saved searches to get alerts.</p>
  </div>
  {% endif %}
</div>

<style>
  .paper-card {
    transition: all 0.2s ease;
    border-left: 4px solid #dee2e6;
  }
  
  .paper-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }
  
  .paper-card[data-database="pubmed"] {
    border-left-color: #17a2b8;
  }
  
  .paper-card[data-database="arxiv"] {
    border-left-color: #ffc107;
  }
</style>

<script>
  // Add data-database attribute to paper cards for styling
  document.addEventListener('DOMContentLoaded', function() {
    const paperCards = document.querySelectorAll('.paper-card');
    paperCards.forEach(card => {
      const badge = card.querySelector('.badge');
      if (badge) {
        const database = badge.textContent.trim().toLowerCase();
        card.setAttribute('data-database', database);
      }
    });
  });
</script>
{% endblock %}
